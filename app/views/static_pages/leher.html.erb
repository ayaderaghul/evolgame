<% provide(:title, "Le Her") %>

<h1> Introduction </h1>

<p class="videoframe">
<iframe width="100%" height="315" src="https://www.youtube.com/embed/bUjlIcKAi7E" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<p><i>
this is <a href="https://youtu.be/IWd-2HmtQ_Y" target="_blank">after</a> the cold bath</i>
</p>

<h1>le Her</h1>
<p>
There is a book that talks about precursors in mathematical economics, in which mentions a Waldegrave who lived in late 17th century. He studied a game called <i>le Her </i> in French which is <i> the gentleman </i> in English and <i> der Herr </i> in German. He communicated with Monmort about his thoughts on how the game <i>should</i> be played. Monmort then forwarded the thread to Bernoulli and the three (variants said that there are some others) formed a slack.
</p>
<p>
Anyway, while the two latter mathematicians were discussing on ways of playing and the probability of winning for each way of playing, Waldegrave went further to describe a way of mixing over these <i>ways</i>, and made a remark that it was "such an unusual way of playing". It is truly remarkable that extra step Waldegrave took, especially because the way it is deducted seems just as natural as it seems strange.
</p>

<h2> The game </h2>
<i> adapted from Kuhn's description </i>
<p> There are two players: A and B. A deals B a single card at random from an ordinary deck of cards, then deals a single card to himself; neither sees the card dealt to the other. The cards have value in order from the lowest to highest: ace, two, three.. ten, jack, queen, king.</p>

<p> Who has higher card wins. So if B is not satisfied with his card, she can tell A to exchange cards, except if A has dealt herself a king, in that case A automatically wins. If B tells to exchange, and after the exchange, A is not happy, A can exchange it for another card dealt from the deck at random. </p>
<p>However, if the third card dealt from the deck is a king, the exchange is not allowed and A has to keep her card and automatically loses. They now compare cards and who has higher card wins. If they hold equal cards, A wins.
</p>

<h2> Different ways to play </h2>
<p>
Because there are 13 possible cards, a way to play (a policy) need to describe to you what to do in all 13 cases in which you possibly receive one of those 13 cards.
</p>

<p> For player B, here is one such way, as an example: </p>

<pre>

  | A | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | J | Q | K |
  |---|---|---|---|---|---|---|---|---|----|---|---|---|
  | C | C | H | C | H | C | C | C | C | C  | H | H | H |

</pre>

<p>With C is to change the card, and H is to hold the card. We can see that, with 13 slots and each slot has 2 possible actions (C or H), the total possibility is 2^13. We can call one way to play a strategy, and the set of 2^13 strategy is the strategy set.</p>

<p> Similarly, player A has the same strategy set. </p>

<p> If we start to plot the 2^13 x 2^12 strategy space in our head, it gets difficult. </p>

<p> Let's make a move that would drastically weed out strategies that seem to have no reason at all (i.e. the ones that are clearly <i>dominated</i> by other strategies). All the strategies in the form of a mixed sequence of C and H here and there (like, C C C H C C H C H..) are dominated by one of those 14 strategies with k first components are C and the rest are H (like C C C H H H H..) </p>

<p> We have 14 strategies left, and we can go further to remove some of them. Think about the saying: change the low card and hold the high one. From B's point of view, if she is dealt a low card, she feels like to change and if dealt a high card, she feels like to keep. For B, the tie is at card 7. If dealt 8 and above, she keeps, if received 6 and below, she changes. If dealt 7, she needs to think. From A's point of view, the tie is at card 8. If dealt 8, she needs to think. All the other strategies are dominated by these ones. I plot these survived strategies in the following table:  </p>

<pre>

   | A | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | J | Q | K |
   |---|---|---|---|---|---|---|---|---|----|---|---|---|
A1 | C | C | C | C | C | C | C | C | H | H  | H | H | H |
A2 | C | C | C | C | C | C | C | H | H | H  | H | H | H |
B1 | C | C | C | C | C | C | C | H | H | H  | H | H | H |
B2 | C | C | C | C | C | C | H | H | H | H  | H | H | H |

</pre>

<p> The next question we ask, let's match A1 and B1, just to see. We know that the deck has 52 cards, comprising of 13 types of cards multiplied by 4 cards for a same number. So each player can receive one of those 13 possible cards. There can be 13*13 = 169 possible outcomes. Let's calculate the probability to win for B in these possible outcomes. </p>

<pre>

B \ A| A | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | J | Q | K |
-----|---|---|---|---|---|---|---|---|---|----|---|---|---|
   A |   |   |   |   |   |   |   |   |   |    |   |   |   |
   1 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   2 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   3 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   4 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   5 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   6 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   7 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   8 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   9 |   |   |   |   |   |   |   |   |   |    |   |   |   |
   10|   |   |   |   |   |   |   |   |   |    |   |   |   |
   J |   |   |   |   |   |   |   |   |   |    |   |   |   |
   Q |   |   |   |   |   |   |   |   |   |    |   |   |   |
   K |   |   |   |   |   |   |   |   |   |    |   |   |   |
   
   
</pre>

<p> If A is dealt a K, A wins at 100%. Therefore the probability to win for B is 0 regardless of the card B got. So the last column is filled with 0. In case B is dealt a K, except for the case that A also get a K, B automatically wins. Therefore the last row (except the last column) is filled with 1. We fill in the table as follows:</p>


<pre>

B \ A| A | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | J | Q | K |
-----|---|---|---|---|---|---|---|---|---|----|---|---|---|
   A |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   1 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   2 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   3 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   4 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   5 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   6 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   7 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   8 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   9 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   10|   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   J |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   Q |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   K | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1  | 1 | 1 | 0 |
   
   
</pre>

<p> Now let's look at the first cell, it is the one that both are dealt an Ace. To know what to do next, we check their strategies A1 and B1: </p>
<pre>

   | A | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | J | Q | K |
   |---|---|---|---|---|---|---|---|---|----|---|---|---|
A1 | C | C | C | C | C | C | C | C | H | H  | H | H | H |
B1 | C | C | C | C | C | C | C | H | H | H  | H | H | H |

</pre>

Given an ace, both want to change the card. Hence with (Ace, Ace), and (Change, Change), things happen as follows: B changes. A knows that B now has Ace, and she knows that Ace loses to all other cards. So the probability to win for B in this case is 0. This translates into the action of putting 0 in the first cell. </p>

<pre>

B \ A| A | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | J | Q | K |
-----|---|---|---|---|---|---|---|---|---|----|---|---|---|
   A | 0 |   |   |   |   |   |   |   |   |    |   |   | 0 |
   1 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   2 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   3 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   4 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   5 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   6 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   7 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   8 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   9 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   10|   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   J |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   Q |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   K | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1  | 1 | 1 | 0 |
   
</pre>

<p> Cool, let's try the next cell. With (Ace, 2) and (Change, Change): B changes Ace for 2. A know knows that B has 2, and she changes. B can hope that A would get a card smaller than 2 (which is one of the 3 Aces left) or one of the 4 kings) because the rules say that if A get a King now, A cannot change and has to keep the Ace. The prospect is 7 cards out of the remaining 50 cards. The probability to win for B therefore is 7/50.</p>


<pre>

B \ A| A | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | J | Q | K |
-----|---|---|---|---|---|---|---|---|---|----|---|---|---|
   A | 0 |.14|   |   |   |   |   |   |   |    |   |   | 0 |
   1 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   2 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   3 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   4 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   5 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   6 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   7 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   8 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   9 |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   10|   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   J |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   Q |   |   |   |   |   |   |   |   |   |    |   |   | 0 |
   K | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1  | 1 | 1 | 0 |
   
   
</pre>


<p> Mamma mia, let's try to automate the process of filling this table. </p>

<p> Need: We need to write a function that inputs 2 strategies by 2 players, and 2 cards dealt to 2 players respectively and then outputs the probability to win for B.</p>

<p> We can articulate this task in the following steps: </p>

<ul>
  <li> If A gets a King, the returned number is 0. </li>
  <li> After we check for the above condition, we check whether B gets a King. If yes, the returned number is 1. Otherwise, move forward. </li>
  <li> According to their strategies, do they want to change the card? </li>
  <li> If B changes, she gets the card of A. At this point we know for sure the card B would hold. </li>
  <li> If A changes, she gets a new card from the deck. At this point, we can count the number of cards in the deck that favor B. They are cards lower than the one B currently holding and all the Kings. </li>
</ul>

<p> With this description, you can proceed to express the task in the language of your choice. I would write in Racket but I do understand and code in other languages (Python, Ruby, Go, C) and I would like to learn more about other languages (Clojure, R, Matlab etc) so if you have solutions in these languages I would still like to have a look. </p>    

<p> I always try to get a REPL, you may find online REPLs for many langs. </p>

First, I write a function to see if one person want to change the card <code>x</code> or not. Because a strategy can be described as a threshold at which the person starts to hold the card, I call the parameter <code>xhold</code>.

<pre class="prettyprint linenums:1">
  
  (define (change? x xhold)
  (>= x xhold))
  
</pre>

Second, I write a function to swap the cards, for B to swap if she decides to change:


  <pre class="prettyprint linenums:4">

  (define (swap x y)
  (list y x))
  
</pre>

Third, if A does not change her card during the play, we can just compare their cards to decide the probability to win of B. If A holds a card of at least as high as B, A wins.

  <pre class="prettyprint linenums:7">

  (define (compare a b)
  (if (>= a b) 0 1))
  
</pre>

After building the small pieces, now we can write the big function to calculate the probability to win of B in all cases:
  <pre class="prettyprint linenums:10">

; for the sake of a later for loop
; I count cards from 0 to 12.
  
(define (b-to-win a1 b1 ahold bhold)
 (cond
  [(= a1 12) 0]
  [(= b1 12) 1]
  [else
   (begin
    (match-define (list a2 b2)
     (if (change? b1 bhold) (swap a1 b1) (list a1 b1)))
    (define a3 (if (>= a2 ahold) a2 -1))
    (if (not (= a3 -1))
     (compare a3 b2)
     (exact->inexact (/ (+ (smaller b2 a2)
                        (if (< a2 b2) 4 0)) 50))))]))
  </pre>

It seems long, but it is a flow of <code> cond </code> and <code> if </code>.

The first act of the game is when the two cards are first dealt, they are stored in variables a1 and b1 respectively. The first two corner cases we can check easily is when A or B gets the King. It goes sequentially so if it enters the second cond clause, it already means that A does not hold a King, and B automatically wins. If none holds a King, the second act of the game begins, with the question whether B wants to change her card or not.

Define new variables a2 b2 to hold the card A and B have in the second act of the game: if B wants to change, the cards are swapped, if not, the cards stay the same but are hold in the new labels.

Then we proceed to the third act of the game: whether A gets a new random card from the deck or not, according to her strategy. If she holds, the card is the same and is stored in the new variable a3, if not, the variable a3 holds the number -1.

At this point the game course ends and we can check the card to see who wins. If A did not change the card in the third act, we can just compare a2 (or a3) and b2. If A draws a new card, to calculate the probability for B to win, we need to calculate the number of cards in the deck that is favorable to B.

A get the one that is smaller than the one currently in B's hand (b2).The number of cards in the deck that are smaller than b2 has to take into account the card already in A's hand.

if a2 is already smaller than b2 AND A get a King. in this case A has to return the King and accept the one she has (a2).

For example, if b2 is 3 and a2 is 2 and A changes, B hopes for A to draw one of those 4 Aces, 3 Twos left in the deck, 4 Kings. If b2 is 3 and a2 is 4 and A changes, B hopes for A to draw one of those 4 Aces and 4 Twos in the deck. In this case, if A get a King, A returns the King and has 4 and still wins.

So we write function <code> how-many-smaller </code>
  <pre class="prettyprint linenums:27">

(define (how-many-smaller b a)
        (define counters (range b))
        (foldl (lambda (nxt init) (if (= nxt a)
                                      (+ 3 init) (+ 4 init)))
               0 counters))

</pre>

In the above function, variable counters are the range of cards smaller than the one B holding. And during the fold, if it happens to be equal to the one A currently holding, we only add 3 instead of 4.

We can see that in the big funciton b-to-win, after counting how many smaller cards, we add 4 kings and then divide them all by 50. 50 is the number of cards currently in the deck (2 already in 2 players' hand).

Now this function is to calculate the probability to win for A and B at each possible deal of the cards, regarding their strategy. If we fix the strategy, i.e. for A to hold from 7 and B to hold from 8, we can run a nested for loop through the range of 13 possible cards and generate a matrix for the 13*13=169 possible deals.

  <pre class="prettyprint linenums:33">
    
(define (b-to-win-at-78 a1 b1)
	(b-to-win a1 b1 7 8))

(for/list ([j (in-range 13)])
 (for/list ([i (in-range 13)])
  (b-to-win-at-78 i j)))

</pre>
  <pre class="prettyprint">
    
> (load "win.rkt")
'((0.0 0.14 0.22 0.3 0.38 0.46 0.54 0.62 0.7 0.78 0.86 0.94 0)
  (0.0 0.08 0.22 0.3 0.38 0.46 0.54 0.62 0.7 0.78 0.86 0.94 0)
  (0.0 0.08 0.16 0.3 0.38 0.46 0.54 0.62 0.7 0.78 0.86 0.94 0)
  (0.0 0.08 0.16 0.24 0.38 0.46 0.54 0.62 0.7 0.78 0.86 0.94 0)
  (0.0 0.08 0.16 0.24 0.32 0.46 0.54 0.62 0.7 0.78 0.86 0.94 0)
  (0.0 0.08 0.16 0.24 0.32 0.4 0.54 0.62 0.7 0.78 0.86 0.94 0)
  (0.0 0.08 0.16 0.24 0.32 0.4 0.48 0.62 0.7 0.78 0.86 0.94 0)
  (0 0 0 0 0 0 0 0 1 1 1 1 0)
  (0.7 0.7 0.7 0.7 0.7 0.7 0.7 1 0 0 0 0 0)
  (0.78 0.78 0.78 0.78 0.78 0.78 0.78 1 1 0 0 0 0)
  (0.86 0.86 0.86 0.86 0.86 0.86 0.86 1 1 1 0 0 0)
  (0.94 0.94 0.94 0.94 0.94 0.94 0.94 1 1 1 1 0 0)
  (1 1 1 1 1 1 1 1 1 1 1 1 0))
      
</pre>


<footer>
  Discord: <a href="https://discord.gg/Jbjj6NS" target="_blank">chat</a> | Github: <a href="https://github.com/ayaderaghul/evolgame" target="_blank"> repo </a>
  
</footer>
